<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Story Points Chart</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <link rel="icon" type="image/x-icon" href="https://mohan-chinnappan-n5.github.io/dfv/img/mc_favIcon.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.27.0/min/vs/editor/editor.main.min.css">


  <link rel="stylesheet" href="https://mohan-chinnappan-n5.github.io/delta/style.css">
  <script src="https://mohan-chinnappan-n.github.io/sfdc/gs/js/split.js"></script>
  <link rel="stylesheet" href="https://mohan-chinnappan-n.github.io/sfdc/gs/css/split.css">

    <style>
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
        }

        .grid-line {
            stroke: lightgray;
            stroke-opacity: 0.7;
        }

        .sprint-bar {
            fill: steelblue;
        }

        .story-bar {
            fill: lightblue;
        }

        .story-text, .total-text, .average-text {
            font-weight: bold;
            text-anchor: middle;
        }

        .y-axis text {
            font-weight: bold;
            text-anchor: end;
        }

        .x-axis text {
            font-weight: bold;
            text-anchor: middle;
        }

        body { min-height: 75rem; padding-top: 4.5rem; }
</style>

</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-dark">
    <a class="navbar-brand" href="#">&nbsp;Sprint Story Points - Velocity Chart</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home</a>
        </li>
      </ul>
    </div>
  </nav>

    <div class="split split-horizontal" id="content">
<textarea rows='20' cols='80' id='sprints'>
[
            { "sprint": "Sprint 1",  "stories": [{ "points": 3 }, { "points": 4 }, { "points": 2 }] },
            { "sprint": "Sprint 2",  "stories": [{ "points": 4 }, { "points": 3 }, { "points": 2 }] },
            { "sprint": "Sprint 3",  "stories": [{ "points": 8 }, { "points": 2 }, { "points": 2 }] },
            { "sprint": "Sprint 4",  "stories": [{ "points": 7 }, { "points": 3 }, { "points": 4 }] }

]

</textarea>
      <button id='draw' class='btn btn-primary'>Draw</button>
</div>
  <div class="split split-horizontal" id="graph">
    <svg id="chart"></svg>
   <button id="downloadButton" disabled class='btn btn-success'>Download as SVG</button>

  </div>


    <script>
        const getEle = id => document.getElementById(id);
        const taSprints = getEle('sprints');
        const btnDraw = getEle('draw');
        const downloadButton = getEle('downloadButton');

        Split([ "#content", "#graph"], { sizes: [20, 80] });


        function createSprintChart(chartTitle, sprintData, svgWidth, svgHeight, barLength) {
            const svg = d3.select('#chart')
                .attr('width', svgWidth)
                .attr('height', svgHeight);

            const margin = { top: 40, right: 30, bottom: 50, left: 100 };
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;
            
            //{ sprint: 'Sprint 1', totalPoints: 9, stories: [{ points: 3 }, { points: 4 }, { points: 2 }] },
            const storyPoints = sprintData.reduce((points, sprint) => {
                sprint.stories.forEach(story => {
                    if (!points.includes(story.points)) {
                        points.push(story.points);
                    }
                });
                return points;
            }, []).sort((a, b) => a - b);

           console.log(storyPoints); 
            const xScale = d3.scaleBand()
                .domain(storyPoints.map(d => d.toString()))
                .range([0, width])
                .padding(1);



            const yScale = d3.scaleBand()
                .domain(sprintData.map(d => d.sprint))
                .range([0, height])
                .padding(0.1);

            const colorScale = d3.scaleOrdinal()
                .domain(sprintData.map(d => d.sprint))
                .range(d3.schemeCategory10);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Add chart title
            g.append('text')
                .attr('class', 'chart-title')
                .attr('x', width / 2)
                .attr('y', -margin.top / 2)
                .text(chartTitle);

            // Add horizontal grid lines
            g.selectAll('.grid-line')
                .data(xScale.domain())
                .enter()
                .append('line')
                .attr('class', 'grid-line')
                .attr('x1', d => xScale(d) + xScale.bandwidth() / 2)
                .attr('x2', d => xScale(d) + xScale.bandwidth() / 2)
                .attr('y1', 0)
                .attr('y2', height)
                .style('stroke', '#99ccff')
                .style('stroke-opacity', 0.7);

            let averageVelocity = 0;

            sprintData.forEach(d => {
 
                // Add the sprint bar with a configurable length
                g.append('rect')
                    .attr('class', 'sprint-bar')
                    .attr('x', 0)
                    .attr('y', yScale(d.sprint))
                    .attr('width', xScale(d.totalPoints))
                    .attr('height', yScale.bandwidth())
                    .style('fill', colorScale(d.sprint));

                // Calculate and display the average story points for the sprint
                const averageStoryPoints = d.stories.reduce((sum, story) => sum + story.points, 0) / d.stories.length;

                // Add subgraphs for each story within the sprint
                const subgraph = g.append('g')
                    .attr('class', 'subgraph')
                    .attr('transform', `translate(0, ${yScale(d.sprint)})`);

                console.log(d.totalPoints)
                averageVelocity = d.averageVelocity;
                subgraph.selectAll('.story-bar')
                    .data(d.stories)
                    .enter()
                    .append('rect')
                    .attr('class', 'story-bar')
                    .attr('x', 0) // Start from the beginning of the subgraph
                    .attr('y', (story, i) => i * 31)
                    .attr('width', story => xScale(parseInt(story.points))) // Use the scaled width
                    .attr('height', 30)
                    .style('fill', colorScale(d.sprint))

                // Add story points text inside the bars (centered)
                subgraph.selectAll('.story-text')
                    .data(d.stories)
                    .enter()
                    .append('text')
                    .attr('class', 'story-text')
                    .attr('x', story => xScale(story.points) / 2) // Centered within the bar
                    .attr('y', (story, i) => i * barLength + barLength / 2)
                    .attr('dy', '0.35em')
                    .text(story => `${story.points} pts, velocity: ${d.totalPoints}`);
            });

            // Add the y-axis labels
            g.append('g')
                .attr('class', 'y-axis')
                .call(d3.axisLeft(yScale).tickSize(0))
                .selectAll('text')
                .attr('dx', '-0.5em') // Adjust the text position
                .attr('dy', '0.25em')
                .style('text-anchor', 'end')
                .style('font-weight', 'bold');

            // Add x-axis label and ticks
            g.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(xScale).tickSize(0))
                .selectAll('text')
                .style('text-anchor', 'middle')
                .style('font-weight', 'bold');

            // Add x-axis label
            g.append('text')
                .attr('class', 'x-axis-label')
                .attr('x', width / 2)
                .attr('y', height + margin.bottom - 10)
                .style('text-anchor', 'middle')
                .style('font-weight', 'bold')
                    .text(`Story Points - AverageVelocity: ${averageVelocity}`);
        }


        const chartTitle = "Velocity Chart";
         btnDraw.addEventListener('click', event => {
           const svg = d3.select('#chart');
           svg.selectAll('*').remove();
         // Example usage:
        const sprintData =  JSON.parse(taSprints.value);

        // Calculate and add totalPoints to each sprint
        sprintData.forEach(sprint => {
            const totalPoints = sprint.stories.reduce((acc, story) => acc + story.points, 0);
            sprint.totalPoints = totalPoints;
        });


        // Calculate the averageVelocity
        const totalPointsSum = sprintData.reduce((acc, sprint) => acc + sprint.totalPoints, 0);
        const averageVelocity = totalPointsSum / sprintData.length;

        // Add the averageVelocity to each sprint
        sprintData.forEach(sprint => {
            sprint.averageVelocity = averageVelocity;
        });

          createSprintChart(chartTitle, sprintData, 1200, 900, 30);
          getEle('downloadButton').disabled = false;
        });
        btnDraw.click();

        // download
        function saveSvg() {
            const svgEl = getEle('chart');

            svgEl.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            var svgData = svgEl.outerHTML;
            var preface = '<?xml version="1.0" standalone="no"?>\r\n';
            var svgBlob = new Blob([preface, svgData], {type:"image/svg+xml;charset=utf-8"});
            var svgUrl = URL.createObjectURL(svgBlob);
            var downloadLink = document.createElement("a");
            downloadLink.href = svgUrl;
            downloadLink.download = `${chartTitle.replace(' ','')}.svg`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
        // Add event listener to the download button
        getEle("downloadButton").addEventListener("click", saveSvg);




    </script>
</body>
</html>

